<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Admin - Empleados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Listado de empleados (Usuarios)</h2>
    <div>
        <a href="admin.html" class="btn btn-outline-secondary me-2">Volver al Dashboard</a>
        <button class="btn btn-outline-danger">Cerrar sesión</button>
    </div>
  </div>

  <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalEmpleado" onclick="abrirModal()">➕ Agregar nuevo empleado</button>
  
  <table class="table table-striped table-bordered" id="tablaEmpleados">
    <thead class="table-dark">
      <tr>
        <th>ID</th><th>Nombre</th><th>Rol</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filas dinámicas -->
    </tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="modalEmpleado" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" onsubmit="guardarEmpleado(event)">
      <div class="modal-header"><h5 class="modal-title" id="modalTitulo">Nuevo Empleado</h5></div>
      <div class="modal-body">
        <input type="hidden" id="empleadoId">
        <input type="text" id="nombre" class="form-control mb-2" placeholder="Nombre completo" required>
        <select id="rol" class="form-select mb-2" required>
            <option value="">Selecciona un puesto...</option>
            <option value="Administrador">Administrador</option>
            <option value="Recepcionista">Recepcionista</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" type="submit">Guardar</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
let empleados = [];

window.onload = obtenerEmpleados;

async function obtenerEmpleados() {
  try {
    const respuesta = await fetch('api_usuarios.php');
    if (!respuesta.ok) throw new Error("Error en el servidor PHP");
    empleados = await respuesta.json();
    renderTabla();
  } catch (error) {
    console.error(error);
    alert("❌ Error: No se pudo conectar con la base de datos.");
  }
}

function renderTabla() {
  const tbody = document.querySelector("#tablaEmpleados tbody");
  tbody.innerHTML = "";
  empleados.forEach(emp => {
    const fila = `
      <tr>
        <td>${emp.id_usuario}</td>
        <td>${emp.nombre}</td>
        <td><span class="badge bg-info text-dark">${emp.rol}</span></td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="editarEmpleado(${emp.id_usuario})">Editar</button>
          <button class="btn btn-danger btn-sm" onclick="eliminarEmpleado(${emp.id_usuario})">Eliminar</button>
        </td>
      </tr>`;
    tbody.innerHTML += fila;
  });
}

function abrirModal() {
  document.getElementById("modalTitulo").textContent = "Nuevo Empleado";
  document.getElementById("empleadoId").value = "";
  document.getElementById("nombre").value = "";
  document.getElementById("rol").value = "";
}

async function guardarEmpleado(event) {
  event.preventDefault();
  const id = document.getElementById("empleadoId").value;
  const payload = {
    id_usuario: id,
    nombre: document.getElementById("nombre").value,
    rol: document.getElementById("rol").value
  };

  const metodo = id ? 'PUT' : 'POST';

  await fetch('api_usuarios.php', {
    method: metodo,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  obtenerEmpleados();
  bootstrap.Modal.getInstance(document.getElementById("modalEmpleado")).hide();
}

function editarEmpleado(id) {
  const emp = empleados.find(e => e.id_usuario == id);
  document.getElementById("modalTitulo").textContent = "Editar Empleado";
  document.getElementById("empleadoId").value = emp.id_usuario;
  document.getElementById("nombre").value = emp.nombre;
  document.getElementById("rol").value = emp.rol;
  new bootstrap.Modal(document.getElementById("modalEmpleado")).show();
}

async function eliminarEmpleado(id) {
  if (confirm("¿Seguro que deseas eliminar este empleado?")) {
    await fetch('api_usuarios.php', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id_usuario: id })
    });
    obtenerEmpleados();
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>