<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Admin - Socios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="shortcut icon" href="img/businessman.png" type="image/x-icon">
</head>
<body>
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Listado de socios</h2>
    <div>
      <a href="admin.html" class="btn btn-outline-secondary me-2">Volver al Dashboard</a>
      <button class="btn btn-outline-danger">Cerrar sesión</button>
    </div>
  </div>

  <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalSocio" onclick="abrirModal()">➕ Agregar nuevo socio</button>
  
  <table class="table table-striped table-bordered" id="tablaSocios">
    <thead class="table-dark">
      <tr>
        <th>ID</th><th>Nombre</th><th>Correo</th><th>Teléfono</th><th>Estatus</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filas dinámicas -->
    </tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="modalSocio" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" onsubmit="guardarSocio(event)">
      <div class="modal-header"><h5 class="modal-title" id="modalTitulo">Nuevo Socio</h5></div>
      <div class="modal-body">
        <input type="hidden" id="socioId">
        <input type="text" id="nombre" class="form-control mb-2" placeholder="Nombre completo" required>
        <input type="email" id="correo" class="form-control mb-2" placeholder="Correo electrónico" required>
        <input type="text" id="telefono" class="form-control mb-2" placeholder="Teléfono" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" type="submit">Guardar</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
let socios = [];

window.onload = obtenerSocios;

async function obtenerSocios() {
  try {
    const respuesta = await fetch('api_socios.php');
    if (!respuesta.ok) throw new Error("Error en el servidor PHP");
    socios = await respuesta.json();
    renderTabla();
  } catch (error) {
    console.error(error);
    alert("❌ Error: No se pudo conectar con la base de datos.");
  }
}

function renderTabla() {
  const tbody = document.querySelector("#tablaSocios tbody");
  tbody.innerHTML = "";
  socios.forEach(socio => {
    const fila = `
      <tr>
        <td>${socio.id_socio}</td>
        <td>${socio.nombre}</td>
        <td>${socio.correo}</td>
        <td>${socio.telefono}</td>
        <td><span class="badge bg-${socio.estatus === 'activo' ? 'success' : 'danger'}">${socio.estatus}</span></td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="editarSocio(${socio.id_socio})">Editar</button>
          <button class="btn btn-danger btn-sm" onclick="eliminarSocio(${socio.id_socio})">Eliminar</button>
        </td>
      </tr>`;
    tbody.innerHTML += fila;
  });
}

function abrirModal() {
  document.getElementById("modalTitulo").textContent = "Nuevo Socio";
  document.getElementById("socioId").value = "";
  document.getElementById("nombre").value = "";
  document.getElementById("correo").value = "";
  document.getElementById("telefono").value = "";
}

async function guardarSocio(event) {
  event.preventDefault();
  const id = document.getElementById("socioId").value;
  const payload = {
    id_socio: id,
    nombre: document.getElementById("nombre").value,
    correo: document.getElementById("correo").value,
    telefono: document.getElementById("telefono").value
  };

  const metodo = id ? 'PUT' : 'POST';

  await fetch('api_socios.php', {
    method: metodo,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  obtenerSocios();
  bootstrap.Modal.getInstance(document.getElementById("modalSocio")).hide();
}

function editarSocio(id) {
  const socio = socios.find(s => s.id_socio == id);
  document.getElementById("modalTitulo").textContent = "Editar Socio";
  document.getElementById("socioId").value = socio.id_socio;
  document.getElementById("nombre").value = socio.nombre;
  document.getElementById("correo").value = socio.correo;
  document.getElementById("telefono").value = socio.telefono;
  new bootstrap.Modal(document.getElementById("modalSocio")).show();
}

async function eliminarSocio(id) {
  if (confirm("¿Seguro que deseas eliminar este socio permanentemente?")) {
    await fetch('api_socios.php', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id_socio: id })
    });
    obtenerSocios();
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>