<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Fitness Plus - Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style> 
    body.dark-mode { background-color: #121212; color: #e0e0e0; } 
    body.dark-mode .card { background-color: #1e1e1e; color: #e0e0e0; } 
    body.dark-mode .alert-info { background-color: #0d3b66; color: #fff; border: none; }
  </style> 
</head> 
<body> 
<div class="container mt-4"> 
  <div class="d-flex justify-content-between align-items-center mb-4"> 
    <h2 class="fw-bold">Dashboard Fitness Plus</h2> 
    <div> 
      <button class="btn btn-outline-secondary me-2" onclick="toggleDarkMode()">üåô</button> 
      <button class="btn btn-danger">Cerrar sesi√≥n</button> 
    </div> 
  </div>

  <div id="statusConnection" class="alert alert-success d-none" role="alert"> 
    ‚úÖ Sincronizado con SQL Server correctamente.
  </div>
  
  <!-- Tarjetas de M√©tricas -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-center shadow-sm border-0 bg-success text-white">
        <div class="card-body">
          <h5 class="card-title opacity-75">Socios Activos</h5>
          <p class="card-text display-5 fw-bold" id="txtSocios">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center shadow-sm border-0 bg-info text-white">
        <div class="card-body">
          <h5 class="card-title opacity-75">Empleados</h5>
          <p class="card-text display-5 fw-bold" id="txtEmpleados">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center shadow-sm border-0 bg-dark text-white">
        <div class="card-body">
          <h5 class="card-title opacity-75">Total Global</h5>
          <p class="card-text display-5 fw-bold" id="txtTotal">0</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Accesos r√°pidos -->
  <div class="row mb-5">
    <div class="col-md-6 mb-2">
      <a href="admin-panel.html" class="btn btn-primary btn-lg w-100 shadow-sm">üë• Gestionar Socios</a>
    </div>
    <div class="col-md-6 mb-2">
      <a href="admin_empleados.html" class="btn btn-secondary btn-lg w-100 shadow-sm">üëî Gestionar Empleados</a>
    </div>
  </div>

  <!-- Gr√°ficas Reales -->
  <div class="row">
    <div class="col-md-7">
      <div class="card p-3 shadow-sm border-0">
        <h6 class="text-muted mb-3">Distribuci√≥n de Usuarios</h6>
        <canvas id="chartPrincipal" height="150"></canvas>
      </div>
    </div>
    <div class="col-md-5">
        <div class="card p-3 shadow-sm border-0 text-center">
            <h6 class="text-muted mb-3">Estado de Base de Datos</h6>
            <p id="dbInfo" class="small text-success">Cargando informaci√≥n del servidor...</p>
        </div>
    </div>
  </div>
</div>

<script>
function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
}

let chartInstance = null;

async function actualizarDashboard() {
  try {
    // 1. Llamar a las APIs de PHP que creamos
    const [resSocios, resUsuarios] = await Promise.all([
      fetch('api_socios.php'),
      fetch('api_usuarios.php')
    ]);

    // DETECTOR DE ERRORES PHP: Si el servidor falla, leemos el mensaje de error
    if (!resSocios.ok || !resUsuarios.ok) {
        const errText = await resSocios.text();
        throw new Error(errText.includes('FALTA_EXTENSION') 
            ? "A tu servidor (XAMPP/Laragon) le falta la extensi√≥n SQLSRV de PHP." 
            : "No se pudo conectar a la base de datos.");
    }

    const socios = await resSocios.json();
    const empleados = await resUsuarios.json();

    // 2. Procesar datos seg√∫n tu l√≥gica de BD
    // En tu BD, los socios tienen 'estatus' (activo/inactivo)
    const sociosActivos = socios.filter(s => s.estatus === 'activo').length;
    const numEmpleados = empleados.length;
    const total = socios.length + numEmpleados;

    // 3. Actualizar la interfaz
    document.getElementById("txtSocios").textContent = sociosActivos;
    document.getElementById("txtEmpleados").textContent = numEmpleados;
    document.getElementById("txtTotal").textContent = total;
    document.getElementById("statusConnection").classList.remove("d-none");
    document.getElementById("dbInfo").textContent = "Conectado a: .\\SQLEXPRESS (gimnasio)";

    // 4. Crear o actualizar la gr√°fica
    const ctx = document.getElementById('chartPrincipal').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    
    chartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Socios Activos', 'Socios Inactivos', 'Empleados'],
        datasets: [{
          data: [sociosActivos, socios.length - sociosActivos, numEmpleados],
          backgroundColor: ['#28a745', '#dc3545', '#17a2b8'],
          borderWidth: 0
        }]
      },
      options: {
        plugins: { legend: { position: 'bottom' } },
        cutout: '70%'
      }
    });

  } catch (error) {
    console.error("Error al sincronizar con SQL Server:", error);
    document.getElementById("dbInfo").className = "text-danger fw-bold";
    document.getElementById("dbInfo").textContent = "Error del servidor.";
    
    // Mostramos el error exacto en la caja verde (ahora roja)
    const statusDiv = document.getElementById("statusConnection");
    statusDiv.classList.remove("d-none", "alert-success");
    statusDiv.classList.add("alert-danger");
    statusDiv.innerHTML = "‚ùå " + error.message;
  }
}

// Cargar al iniciar la p√°gina
window.onload = actualizarDashboard;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>